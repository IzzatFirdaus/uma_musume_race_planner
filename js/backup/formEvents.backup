// js/formEvents.js

export function attachActionEventHandlers(onView, onEdit, onDelete) {
  document.querySelectorAll(".view-btn").forEach(btn => {
    btn.onclick = () => onView?.(btn.dataset.id);
  });

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.onclick = () => onEdit?.(btn.dataset.id);
  });

  document.querySelectorAll(".delete-btn").forEach(btn => {
    if (!onDelete) return;
    btn.onclick = () => {
      if (confirm("Are you sure you want to delete this plan?")) {
        onDelete(btn.dataset.id);
      }
    };
  });
}

export function initFilterForm(onPlansLoaded) {
  const form = document.getElementById("filterForm");
  if (!form) return;

  const submitBtn = form.querySelector("button[type='submit']");
  const resetBtn = document.getElementById("resetFiltersBtn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.innerHTML = `<i class="bi bi-arrow-repeat me-1"></i> Filtering...`;

    const params = new URLSearchParams();
    new FormData(form).forEach((val, key) => {
      const trimmed = val?.toString().trim();
      if (trimmed) {
        params.append(key, trimmed);
      }
    });

    try {
      const res = await fetch(`get_plans.php?${params.toString()}`, {
        headers: { Accept: "application/json" },
      });
      const data = await res.json();
      onPlansLoaded?.(data);
    } catch (err) {
      console.error("Error loading filtered plans", err);
      alert("Unable to load filtered plans.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<i class="bi bi-search me-1"></i> Search`;
    }
  });

  resetBtn?.addEventListener("click", () => {
    form.reset();
    form.dispatchEvent(new Event("submit"));
  });
}
