<?php

// get_plan_details.php
header('Content-Type: application/json');
$pdo = require __DIR__ . '/includes/db.php'; // Correct: Use the new PDO connector

$planId = isset($_GET['id']) ? (int)$_GET['id'] : 0;

if ($planId <= 0) {
    http_response_code(400);
    echo json_encode(['error' => 'Invalid plan ID.']);
    exit;
}

try {
    // Fetch main plan details
    $sql = '
        SELECT p.*, m.label AS mood_label, s.label AS strategy_label
        FROM plans p
        LEFT JOIN moods m ON p.mood_id = m.id
        LEFT JOIN strategies s ON p.strategy_id = s.id
        WHERE p.id = ? AND p.deleted_at IS NULL
    ';
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$planId]);
    $plan = $stmt->fetch();

    if ($plan) {
        // Fetch and attach related data to the main plan array

        // 1. Fetch attributes
        $stmt_attr = $pdo->prepare('SELECT attribute_name, value, grade FROM attributes WHERE plan_id = ? ORDER BY id');
        $stmt_attr->execute([$planId]);
        $plan['attributes'] = $stmt_attr->fetchAll();

        // 2. Fetch skills
        $stmt_skills = $pdo->prepare('SELECT skill_name, sp_cost, acquired, tag, notes FROM skills WHERE plan_id = ? ORDER BY id');
        $stmt_skills->execute([$planId]);
        $plan['skills'] = $stmt_skills->fetchAll();

        // 3. Fetch race predictions
        $stmt_preds = $pdo->prepare('SELECT * FROM race_predictions WHERE plan_id = ? ORDER BY id');
        $stmt_preds->execute([$planId]);
        $plan['race_predictions'] = $stmt_preds->fetchAll();

        echo json_encode($plan);
    } else {
        http_response_code(404);
        echo json_encode(['error' => 'Plan not found.']);
    }
} catch (PDOException $e) {
    http_response_code(500);
    error_log('Get Plan Details Error: ' . $e->getMessage());
    echo json_encode(['error' => 'Database error while fetching plan details.']);
}
